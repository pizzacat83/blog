---
draft: true
published: 2025-03-30
summary: あのイーハトーヴォのすきとおった風、夏でも底に冷たさをもつ青いそら、うつくしい森で飾られたモリーオ市、郊外のぎらぎらひかる草の波。
---
# 自作ブラウザ CSS・スタイリング編

書籍『［作って学ぶ］ブラウザのしくみ』(以下、sababook) を参考にブラウザの自作を進めている。CSS のパースとレンダリングツリーの構築を1つの区切りとして、この記事を書く。sababook の第5章に相当する部分である。

第5章までに出来上がっていたものは、HTTP クライアントと HTML パーサーであった。これらについても追々記事を書きたいが、まずは直近やっている CSS 周りから書いていく。ちなみに自作 HTML パーサーの延長上で「[HTML パーサー自作で理解する Flatt Security XSS Challenge 1](https://pizzacat83.hatenablog.com/entry/2025/01/10/172345)」という記事を書いたので、よかったらこちらも。

## ブラウザ自作プロジェクトについて

ブラウザ自作に対する向き合い方などについてこれまで特に書いていなかったからここで書くことにする。私がブラウザ自作に取り組む目的は主に以下の3点である。

- ブラウザの仕組みや Web の標準の理解を深める
- no_std Rust に触れる
- 自作キーボードのタイピングに慣れる

第一の目的は書名にもあるように、「ブラウザの仕組みや Web の標準の理解を深める」ことである。ブラウザ自作の教材は sababook の他にも「[Web Browser Engineering](https://browser.engineering)」や「[ちいさな Web ブラウザを作ろう](https://browserbook.shift-js.info/)」などがあるが、ブラウザが動く仕組みを深く理解する上で sababook は優れていると感じる。自作ブラウザを自作 OS の上で動かし、`core` と自作 OS が提供するライブラリしか使わないという縛りによって、ブラックボックスである部分がかなり小さくなっている。それに、パーサーコンビネータ等のライブラリを使わないので、定義されている仕様をライブラリの世界観に合わせてどうにか翻訳する必要はなく、仕様書を素直に実装することができる。no_std を使う機会というのもまたありがたい。

自作キーボードの件は脇道に逸れるけれどもモチベーションの一つではある。去年自作キーボードを購入したもののまだタイピング練習を十分にできておらず、練習台として写経の題材が欲しかったのだ。慣れないキーボードで創造的なタスクをやろうとすると、タイプミスに脳のリソースを奪われて創造性が阻害されている感じがするし、フィードバックループが思ったスピードで回せずストレスが溜まってしまう。一方写経的なタスクであれば、コードを書く際にタイピングを意識する脳の余裕は残っている。

そういうモチベでブラウザ自作をやっているので、コードを書く際は Copilot の補完をオフにしている。どうも Copilot の補完は Web の各種標準の知識をしっかり持っているようで、正しい実装を一気に20行ぐらいサジェストしてくるのである。これではブラウザ自作がタブキー連打になってしまう。なんだか手を動かして理解した感じがしないし、タイピングの練習にもならない。

実装は大まかに以下のような流れで進めている。

1. sababook をざっくり読む
2. sababook を参考に、最初のゴールを決める
	- 例: `display` プロパティを扱えるようにする
3. 型定義を書く
4. ゴールをもとにテストを書く
	- 例: `.card { display: block }` を正しくパースできる
5. 仕様書をもとに、テストが通るコードを書く
6. より大きいゴールを定め、3に戻る
7. たまに、Servo や Chromium などの実装を見て比較する

<!-- TODO: 語る -->

ブラウザ自作を始めた時点での、周辺技術に関する私の習熟度についても書いておく。<!-- TODO: かく -->

